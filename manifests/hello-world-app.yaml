---
apiVersion: v1
kind: ConfigMap
metadata:
  name: hello-world-config
  namespace: default
data:
  application.properties: |
    spring.application.name=hello-world
    spring.datasource.url=jdbc:postgresql://hello-postgres-primary:5432/postgres
    spring.datasource.username=postgres
    spring.datasource.driver-class-name=org.postgresql.Driver
    spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
    spring.jpa.hibernate.ddl-auto=update
    server.port=8080
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-world
  namespace: default
  labels:
    app: hello-world
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hello-world
  template:
    metadata:
      labels:
        app: hello-world
    spec:
      containers:
      - name: hello-world
        image: maven:3.9-eclipse-temurin-17
        command: ["/bin/sh"]
        args:
          - -c
          - |
            mkdir -p /app/src/main/java/com/example/demo
            mkdir -p /app/src/main/resources
            
            cat > /app/pom.xml << 'EOF'
            <?xml version="1.0" encoding="UTF-8"?>
            <project xmlns="http://maven.apache.org/POM/4.0.0"
                     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                     xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
                     http://maven.apache.org/xsd/maven-4.0.0.xsd">
                <modelVersion>4.0.0</modelVersion>
                <parent>
                    <groupId>org.springframework.boot</groupId>
                    <artifactId>spring-boot-starter-parent</artifactId>
                    <version>3.2.1</version>
                </parent>
                <groupId>com.example</groupId>
                <artifactId>demo</artifactId>
                <version>0.0.1-SNAPSHOT</version>
                <properties>
                    <java.version>17</java.version>
                </properties>
                <dependencies>
                    <dependency>
                        <groupId>org.springframework.boot</groupId>
                        <artifactId>spring-boot-starter-web</artifactId>
                    </dependency>
                    <dependency>
                        <groupId>org.springframework.boot</groupId>
                        <artifactId>spring-boot-starter-data-jpa</artifactId>
                    </dependency>
                    <dependency>
                        <groupId>org.postgresql</groupId>
                        <artifactId>postgresql</artifactId>
                        <scope>runtime</scope>
                    </dependency>
                </dependencies>
                <build>
                    <plugins>
                        <plugin>
                            <groupId>org.springframework.boot</groupId>
                            <artifactId>spring-boot-maven-plugin</artifactId>
                        </plugin>
                    </plugins>
                </build>
            </project>
            EOF
            
            cat > /app/src/main/java/com/example/demo/DemoApplication.java << 'EOF'
            package com.example.demo;
            
            import org.springframework.boot.SpringApplication;
            import org.springframework.boot.autoconfigure.SpringBootApplication;
            import org.springframework.web.bind.annotation.GetMapping;
            import org.springframework.web.bind.annotation.RestController;
            import org.springframework.beans.factory.annotation.Autowired;
            import javax.sql.DataSource;
            import java.sql.Connection;
            import java.sql.ResultSet;
            import java.sql.Statement;
            
            @SpringBootApplication
            public class DemoApplication {
                public static void main(String[] args) {
                    SpringApplication.run(DemoApplication.class, args);
                }
            }
            
            @RestController
            class HelloController {
                
                @Autowired
                private DataSource dataSource;
                
                @GetMapping("/")
                public String hello() {
                    try (Connection conn = dataSource.getConnection();
                         Statement stmt = conn.createStatement();
                         ResultSet rs = stmt.executeQuery("SELECT version()")) {
                        if (rs.next()) {
                            String version = rs.getString(1);
                            return "<h1>Hello World from Spring Boot!</h1>" +
                                   "<p>Successfully connected to PostgreSQL database!</p>" +
                                   "<p>Database version: " + version + "</p>";
                        }
                    } catch (Exception e) {
                        return "<h1>Hello World from Spring Boot!</h1>" +
                               "<p>Error connecting to database: " + e.getMessage() + "</p>";
                    }
                    return "<h1>Hello World from Spring Boot!</h1>";
                }
                
                @GetMapping("/health")
                public String health() {
                    return "OK";
                }
            }
            EOF
            
            cp /config/application.properties /app/src/main/resources/
            cd /app
            mvn clean package -DskipTests
            java -jar target/demo-0.0.1-SNAPSHOT.jar
        ports:
        - containerPort: 8080
        env:
        - name: SPRING_DATASOURCE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: hello-postgres-pguser-postgres
              key: password
        volumeMounts:
        - name: config
          mountPath: /config
      volumes:
      - name: config
        configMap:
          name: hello-world-config
---
apiVersion: v1
kind: Service
metadata:
  name: hello-world
  namespace: default
  labels:
    app: hello-world
spec:
  type: NodePort
  ports:
  - port: 8080
    targetPort: 8080
    protocol: TCP
    name: http
  selector:
    app: hello-world
---
apiVersion: postgres-operator.crunchydata.com/v1beta1
kind: PostgresCluster
metadata:
  name: hello-postgres
  namespace: default
spec:
  backups:
    pgbackrest:
      image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbackrest:ubi8-2.47-2
      repos:
      - name: repo1
        volume:
          volumeClaimSpec:
            accessModes:
            - ReadWriteOnce
            resources:
              requests:
                storage: 1Gi
  image: registry.developers.crunchydata.com/crunchydata/crunchy-postgres:ubi8-16.1-0
  instances:
  - affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
        - podAffinityTerm:
            labelSelector:
              matchLabels:
                postgres-operator.crunchydata.com/cluster: hello-postgres
                postgres-operator.crunchydata.com/instance-set: pgha1
            topologyKey: kubernetes.io/hostname
          weight: 1
    dataVolumeClaimSpec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 1Gi
    name: pgha1
    replicas: 2
  patroni:
    dynamicConfiguration:
      postgresql:
        parameters:
          log_connections: "on"
          log_disconnections: "on"
        pg_hba:
        - host all postgres 0.0.0.0/0 scram-sha-256
        - host all postgres 0.0.0.0/0 md5
    leaderLeaseDurationSeconds: 30
    port: 8008
    syncPeriodSeconds: 10
  port: 5432
  postgresVersion: 16
  proxy:
    pgBouncer:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchLabels:
                  postgres-operator.crunchydata.com/cluster: hello-postgres
                  postgres-operator.crunchydata.com/role: pgbouncer
              topologyKey: kubernetes.io/hostname
            weight: 1
      config:
        global:
          client_tls_sslmode: disable
          server_tls_sslmode: disable
      image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbouncer:ubi8-1.23-0
      port: 5432
      replicas: 2
  users:
  - name: postgres
    password:
      type: AlphaNumeric
